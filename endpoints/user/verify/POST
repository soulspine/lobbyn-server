#this should never be run standalone, it should only be accessed by sourcing it from request.sh
import clear riot token user

token=$(echo "$body" | jq -r '.token')
password=$(echo "$body" | jq -r '.password')

if [ -z $token ] || [ ${#token} -ne $TOKEN_LENGTH ]; then
    error 400 "Invalid token."
elif [ -z $password ] || [ ${#password} -lt 6 ]; then
    error 400 "Password must be at least 6 characters long."
fi

LOBBYN_CLEAR_ERROR
LOBBYN_TOKEN_get $token

if [ ! -z "$LOBBYN_ERROR_CODE" ]; then
    error "$LOBBYN_ERROR_CODE" "$LOBBYN_ERROR_MESSAGE"
fi

target_icon_id=$(echo $LOBBYN_TOKEN_DATA | jq -r '.iconId')
puuid=$(echo  $LOBBYN_TOKEN_DATA | jq -r '.puuid')
region=$(echo  $LOBBYN_TOKEN_DATA | jq -r '.region')

LOBBYN_CLEAR_ERROR
LOBBYN_RIOT_getUserByPuuid $puuid $region

if [ ! -z "$LOBBYN_ERROR_CODE" ]; then
    error "$LOBBYN_ERROR_CODE" "$LOBBYN_ERROR_MESSAGE"
fi

icon_id=$(echo "$LOBBYN_RIOT_USER" | jq -r '.profileIconId')

if [ "$icon_id" -eq "$target_icon_id" ]; then
    userId=$(uuidgen)
    response_message="$(jo message="User successfully created." userId=$userId)"

    LOBBYN_TOKEN_close $LOBBYN_TOKEN

    LOBBYN_CLEAR_ERROR
    LOBBYN_USER_createUser $userId $password
    LOBBYN_USER_linkPuuid $userId $puuid $region

    response 201 "$response_message"
else
    error 400 "Icon mismatch."
fi